<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>PHP输出缓冲控制ob_start()及其多级缓冲 | 还是码农的缠小溪</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="PHP输出缓冲控制PHP的输出缓冲控制用来控制PHP脚本的输出，这也是PHP的一种缓冲机制的一种，PHP Manual对其有如下介绍

The Output Control functions allow you to control when output is sent from the script. This can be useful in several different situa">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP输出缓冲控制ob_start()及其多级缓冲">
<meta property="og:url" content="http://chanxiaoxi.github.io/2014/05/07/php-output-cache-control/index.html">
<meta property="og:site_name" content="还是码农的缠小溪">
<meta property="og:description" content="PHP输出缓冲控制PHP的输出缓冲控制用来控制PHP脚本的输出，这也是PHP的一种缓冲机制的一种，PHP Manual对其有如下介绍

The Output Control functions allow you to control when output is sent from the script. This can be useful in several different situa">
<meta property="og:updated_time" content="2015-04-20T16:24:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP输出缓冲控制ob_start()及其多级缓冲">
<meta name="twitter:description" content="PHP输出缓冲控制PHP的输出缓冲控制用来控制PHP脚本的输出，这也是PHP的一种缓冲机制的一种，PHP Manual对其有如下介绍

The Output Control functions allow you to control when output is sent from the script. This can be useful in several different situa">
  
    <link rel="alternative" href="/atom.xml" title="还是码农的缠小溪" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">还是码农的缠小溪</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">不懂生活的码农不是好的programer</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://chanxiaoxi.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-php-output-cache-control" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/05/07/php-output-cache-control/" class="article-date">
  <time datetime="2014-05-07T15:54:44.000Z" itemprop="datePublished">2014-05-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PHP输出缓冲控制ob_start()及其多级缓冲
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="PHP输出缓冲控制">PHP输出缓冲控制</h4><p>PHP的输出缓冲控制用来控制PHP脚本的输出，这也是PHP的一种缓冲机制的一种，PHP Manual对其有如下介绍</p>
<blockquote>
<p>The Output Control functions allow you to control when output is sent from the script. This can be useful in several different situations, especially if you need to send headers to the browser after your script has began outputting data. The Output Control functions do not affect headers sent using header() or setcookie(), only functions such as echo and data between blocks of PHP code.</p>
</blockquote>
<ul>
<li>我们都知道PHP是通过header()来设置HTTP报文的，它要求header()必须在任何实际输出之前调用，不管是普通的html标签还是文件里面的空行，空格或者是PHP文件里的空行，空格。</li>
<li>setcookie()函数也是用来设置HTTP报文头，为其添加cookie的，所以他也满足header()函数的要求</li>
</ul>
<p>作为一种输出缓冲控制，在实际中他也有很多用途，这里大概介绍一下，详细的内容可参照<a href="http://rickykwan.iworkshop.com.hk/2010/03/656.html" target="_blank" rel="external">Ricky Kwan</a>的博客<a id="more"></a></p>
<h5 id="1-静态模板技术">1.静态模板技术</h5><p>这其实是用一种动态的方式生成静态模板的技术，在一些类似于CMS的系统中是非常有用的。大致的实现思路是：在动态调用脚本生成相应的HTML之后，我们可以通过该技术来生成静态的模板，供用户下次访问使用，前提是这些模板的内容大多是一成不变的，或者在一定时间内不变的</p>
<pre><code>&lt;?php
ob_start();// 打開緩沖區
?&gt;
&lt;?
<span class="variable">$content</span> = ob_get_contents();//取得php頁面輸出的全部內容
<span class="variable">$fp</span> = fopen(<span class="string">"output00001.html"</span>, <span class="string">"w"</span>); //創建一個文件，并打開，準備寫入
fwrite(<span class="variable">$fp</span>, <span class="variable">$content</span>); //把php頁面的內容全部寫入output00001.html，然后……
fclose(<span class="variable">$fp</span>);
?&gt;
</code></pre><h5 id="2-捕捉输出">2.捕捉输出</h5><p>利用输出缓存机制我们将一些输出内容捕捉，再进行处理，比如PHP语法高亮显示</p>
<pre><code>&lt;?
Function run_code(<span class="variable">$code</span>) {
    If(<span class="variable">$code</span>) {
        ob_start();
        eval(<span class="variable">$code</span>);
        <span class="variable">$contents</span> = ob_get_contents();
        ob_end_clean();
    }else {
        echo <span class="string">"錯誤！沒有輸出"</span>;
        exit();
    }
    return <span class="variable">$contents</span>;
}
</code></pre><h5 id="3-加快传输">3.加快传输</h5><p>利用该机制，对输出类容进行压缩处理，来加快其传输效率</p>
<pre><code>&lt;?
/*
** Title.........: PHP4 HTTP Compression Speeds up the Web
** Version.......: <span class="number">1.20</span>
** Author........: catoc &lt;[email]catoc@<span class="number">163</span>.net[/email]&gt;
** Filename......: gzdoc.php
** Last changed..: <span class="number">18</span>/<span class="number">10</span>/<span class="number">2000</span>
** Requirments...: PHP4 &gt;= <span class="number">4.0</span>.<span class="number">1</span>
** PHP was configured with --with-zlib[=DIR]
** Notes.........: Dynamic Content Acceleration compresses
** the data transmission data on the fly
** code <span class="keyword">by</span> sun jin hu (catoc) &lt;[email]catoc@<span class="number">163</span>.net[/email]&gt;
** Most newer browsers since <span class="number">1998</span>/<span class="number">1999</span> have
** been equipped <span class="keyword">to</span> support the HTTP <span class="number">1.1</span>
** standard known <span class="keyword">as</span> \<span class="string">"content-encoding.\"</span>
** Essentially the browser indicates <span class="keyword">to</span> the
** server that it can accept \<span class="string">"content encoding\"</span>
** and <span class="keyword">if</span> the server is capable it will <span class="keyword">then</span>
** compress the data and transmit it. The
** browser decompresses it and <span class="keyword">then</span> renders
** the page.
**
** Modified <span class="keyword">by</span> John Lim ([email]jlim@natsoft.com.my[/email])
** based on ideas <span class="keyword">by</span> Sandy McArthur, Jr
** Usage........:
** No space before the beginning <span class="keyword">of</span> the first \<span class="string">'&lt;?\'</span> tag.
** ------------Start <span class="keyword">of</span> file----------
** |&lt;?
** | include(\<span class="string">'gzdoc.php\'</span>);
** |? &gt;
** |&lt;HTML&gt;
** |... the page ...
** |&lt;/HTML&gt;
** |&lt;?
** | gzdocout();
** |? &gt;
** -------------End <span class="keyword">of</span> file-----------
*/
ob_start();
ob_implicit_flush(<span class="number">0</span>);
<span class="keyword">function</span> CheckCanGzip(){
global <span class="variable">$HTTP</span>_ACCEPT_ENCODING;
if (headers_sent() || connection_timeout() || connection_aborted()){
    return <span class="number">0</span>;
}
if (strpos(<span class="variable">$HTTP</span>_ACCEPT_ENCODING, \<span class="string">'x-gzip\'</span>) !== false) return \<span class="string">"x-gzip\"</span>;
if (strpos(<span class="variable">$HTTP</span>_ACCEPT_ENCODING,\<span class="string">'gzip\'</span>) !== false) return \<span class="string">"gzip\"</span>;
return <span class="number">0</span>;
}

/* <span class="variable">$level</span> = compression level <span class="number">0</span>-<span class="number">9</span>, <span class="number">0</span>=none, <span class="number">9</span>=max */
<span class="keyword">function</span> GzDocOut(<span class="variable">$level</span>=<span class="number">1</span>,<span class="variable">$debug</span>=<span class="number">0</span>){
<span class="variable">$ENCODING</span> = CheckCanGzip();
if (<span class="variable">$ENCODING</span>){
    print \<span class="string">"n&lt;!-- Use compress $ENCODING --&gt;n\"</span>;
    <span class="variable">$Contents</span> = ob_get_contents();
    ob_end_clean();

    if (<span class="variable">$debug</span>){
        <span class="variable">$s</span> = \<span class="string">"&lt;p&gt;Not compress length: \"</span>.strlen(<span class="variable">$Contents</span>);
        <span class="variable">$s</span> .= \<span class="string">"
        Compressed length: \"</span>.strlen(gzcompress(<span class="variable">$Contents</span>,<span class="variable">$level</span>));
        <span class="variable">$Contents</span> .= <span class="variable">$s</span>;
    }
    header(\<span class="string">"Content-Encoding: $ENCODING\"</span>);
    print \<span class="string">"x1fx8bx08x00x00x00x00x00\"</span>;
    <span class="variable">$Size</span> = strlen(<span class="variable">$Contents</span>);
    <span class="variable">$Crc</span> = crc32(<span class="variable">$Contents</span>);
    <span class="variable">$Contents</span> = gzcompress(<span class="variable">$Contents</span>,<span class="variable">$level</span>);
    <span class="variable">$Contents</span> = substr(<span class="variable">$Contents</span>, <span class="number">0</span>, strlen(<span class="variable">$Contents</span>) - <span class="number">4</span>);
    print <span class="variable">$Contents</span>;
    print pack(\<span class="string">'V\'</span>,<span class="variable">$Crc</span>);
    print pack(\<span class="string">'V\'</span>,<span class="variable">$Size</span>);
    exit;
}else{
    ob_end_flush();
    exit;
}
}
?&gt;
</code></pre><h4 id="ob_start()多级缓冲">ob_start()多级缓冲</h4><p><a href="http://my.oschina.net/CuZn/blog/68650" target="_blank" rel="external">CuZn</a>的一篇博文大概介绍了一下ob_start()的多级缓冲，详细的说明可以参看他的博文，这里只做简单的总结</p>
<p>PHP的输出控制是多级缓冲机制，程序为每个ob_start()开辟一个缓冲区，并且PHP程序本身也有一个最终的输出缓冲区（这里用F代表），举个栗子</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>
ob_start();             <span class="comment">//开启缓冲区A</span>
<span class="keyword">echo</span>   <span class="string">'level 1&lt;br/&gt; '</span>; <span class="comment">//将level 1&lt;br/&gt;保存在A区</span>
ob_start();             <span class="comment">//开启缓冲区B</span>
<span class="keyword">echo</span>   <span class="string">'level 2&lt;br/&gt; '</span>; <span class="comment">//将level 2&lt;br/&gt;保存在B区</span>
ob_start();             <span class="comment">//开启缓冲区C</span>
<span class="keyword">echo</span>   <span class="string">'level 3&lt;br/&gt; '</span>; <span class="comment">//将level 3&lt;br/&gt;保存在C区</span>
ob_end_flush();            <span class="comment">//将缓冲区C输入B区，并关闭 B:level 2&lt;br/&gt;level 3&lt;br/&gt;</span>
ob_end_flush();            <span class="comment">//B-&gt;A，并关闭B A:level 1&lt;br/&gt;level 2&lt;br/&gt;level 3&lt;br/&gt;</span>
ob_end_flush();            <span class="comment">//A-&gt;F，并关闭A F:level 1&lt;br/&gt;level 2&lt;br/&gt;level 3&lt;br/&gt;</span></span>
</code></pre><p>他的输出顺序是 level 1 level 2 level 3，再看一个例子</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>
ob_start(); <span class="comment">//A:null</span>
<span class="keyword">echo</span>   <span class="string">'level 1&lt;br/&gt; '</span>; <span class="comment">//A:level 1&lt;br/&gt;</span>
ob_start(); <span class="comment">//B:null</span>
<span class="keyword">echo</span>   <span class="string">'level 2&lt;br/&gt; '</span>; <span class="comment">//B:level 2&lt;br/&gt;</span>
ob_start(); <span class="comment">//C:null</span>
<span class="keyword">echo</span>   <span class="string">'level 3&lt;br/&gt; '</span>; <span class="comment">//C:level 3&lt;br/&gt;</span>
ob_end_clean(); <span class="comment">//清除C并关闭 </span>
ob_end_flush(); <span class="comment">//B-&gt;A并关闭B A:level 2&lt;br/&gt;level 1&lt;br/&gt;</span>
ob_end_clean(); <span class="comment">//清除A并关闭 F:null</span></span>
</code></pre><p>这里什么都不会输出，由此可以看出，ob_<br>start()的储存是栈的形式，所以每次ob_start()总是取最近的一个，但是ob_end_flush()是队列的形式存取的，所以每次先进的先出</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://chanxiaoxi.github.io/2014/05/07/php-output-cache-control/" data-id="cigyp6dx800001g0r5lp13pj0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/05/10/singleton-pattern-for-php/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          PHP设计模式之单例模式
        
      </div>
    </a>
  
  
    <a href="/2014/05/05/new/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">PHP5.5.X连接MS SQL SEVER</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sourcetree/">Sourcetree</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/octopress/">octopress</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/05/17/hi-docker/">Docker学习笔记(一)——认识Docker</a>
          </li>
        
          <li>
            <a href="/2015/04/20/linux-crontab/">Linux Crontab</a>
          </li>
        
          <li>
            <a href="/2014/12/07/lambda-anonymous-function-and-closure/">Lambda, Anonymous Function And Closure</a>
          </li>
        
          <li>
            <a href="/2014/12/06/php-code-style-guide-psr0/">PHP Code Style Guide---PSR0</a>
          </li>
        
          <li>
            <a href="/2014/12/01/sourcetree-lf-slash-crlf-auto-change-on-windows/">Sourcetree LF/CRLF auto change on Windows</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Gavin Wu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>